<!DOCTYPE html>
<html>
<head>
    <title>Exercicio 10</title>
    <meta charset="UTF-8">

    <style type="text/css">
        .row {
            display: flex;
        }

        .column {
            flex: 50%;
        }

        .hide {
            display: none;
        }
    </style>
</head>
<body>
    <div class="row">
        <div class="column">
            <h1>Itens mais vendidos</h1>

            <label for="description_filter">Filtro por descrição: </label>
            <input id="description_filter" type="text">
            <button onclick="loadItems(document.getElementById('description_filter').value)">Filtrar</button>
            <ul id="items"></ul>
        </div>
        <div class="column">
            <div id="login">
                <h1>Login</h1>
                <h3>Faça o login para visualizar o carrinho de compras</h3>

                <div>
                    <label for="username">Usuário:</label>
                    <input id="username" type="text">
                </div>
                <div>
                    <label for="password">Senha:</label>
                    <input id="password" type="password">
                </div>
                <button onclick="login()">Login</button>
            </div>
            <div id="shopping_cart" class="hide">
                <h1>Carrinho de compras</h1>
            </div>
        </div>
    </div>

    <script type="application/javascript">
        loadItems();
        var token = sessionStorage.getItem('token');
        if(token != null) {
            toggleShoppingCart();
        }

        function getItems(description, onSuccess, onError) {
            var ajax = new XMLHttpRequest();
            ajax.onreadystatechange = function() {
                if (ajax.readyState === 4) {
                    if (ajax.status === 200) {
                        var jsonText = ajax.responseText;
                        var jsonObject = JSON.parse(jsonText);
                        onSuccess(jsonObject);
                    } else {
                        onError(ajax.responseText);
                    }
                }
            };

            var desc = description != null ? 'descricao=' + description : '';
            ajax.open('GET', 'http://localhost:8080/api/v1/products?' + desc, true);
            ajax.send(null);
        }

        function postLogin(username, password, onSuccess, onError) {
            var ajax = new XMLHttpRequest();
            ajax.onreadystatechange = function() {
                if (ajax.readyState === 4) {
                    if (ajax.status === 200) {
                        var jsonText = ajax.responseText;
                        var jsonObject = JSON.parse(jsonText);
                        onSuccess(jsonObject);
                    } else {
                        var text = ajax.responseText;
                        var jsonObject = JSON.parse(text);
                        if(jsonObject != null) {
                            onError(jsonObject);
                        } else {
                            onError(text);
                        }
                    }
                }
            };

            ajax.open('PUT', 'http://localhost:8080/api/v1/login', true);
            var body = JSON.stringify({
                "login": username,
                "password": password
            });
            ajax.send(body);
        }

        function loadItems(description) {
            getItems(description, function(products) {
                var ul = document.getElementById('items');
                ul.innerText = '';
                for(var i = 0; i < products.length; i++) {
                    var product = products[i];
                    var li = document.createElement("li");
                    li.innerHTML =
                        '<p>Nome: ' + product['nome'] + '</p>' +
                        '<p>Descrição: ' + product['descricao'] + '</p>' +
                        '<p>Detalhes: ' + product['detalhes'] + '</p>';
                    ul.appendChild(li);
                }
            }, function(error) {
                console.error(error);
            });
        }

        function toggleShoppingCart() {
            var shoppingCartHtml = document.getElementById('shopping_cart');
            var loginHtml = document.getElementById('login');
            shoppingCartHtml.classList.toggle('hide');
            loginHtml.classList.toggle('hide');
        }

        function login() {
            var username = document.getElementById('username').value;
            var password = document.getElementById('password').value;

            postLogin(username, password, function(tokenDto) {
                toggleShoppingCart();
                token = tokenDto.status;
                sessionStorage.setItem('token', token);
            }, function(error) {
                if(error.status != null) {
                    alert(error.status);
                } else {
                    console.log(error);
                }
            });
        }

    </script>
</body>
</html>
